<link rel="import"
      href="../polymer/lib/elements/dom-module.html">
<link rel="import"
      href="../iron-form/iron-form.html">
<link rel="import"
      href="../sea-element/sea-element-mixin.html">

<dom-module id="sea-form">
  <script>
    (() => {
      'use strict'
      const IronForm = customElements.get('iron-form')

      /**
      * # sea-form
      *
      * **An iron-form that can be submitted by pressing enter, or by a sea-form-submit event**
      *
      * Raises a `sea-form-submitted` event on submit, with the serialized form as detail.
      * Native submission is disabled by default but can be enabled.
      *
      * @polymer
      * @customElement
      * @memberof Sea
      * @extends iron-form
      * @implements { Sea.ElementMixin }
      * @demo demo/index.html
      */
      Sea.Form = class Form extends Sea.ElementMixin(IronForm) {
        static get is () { return 'sea-form' }

        static get properties () {
          return {
            /**
            * Wether the native browser form submission is enabled
            * @type {Boolean}
            * @default false
            */
            nativeSubmissionEnabled: {
              type: Boolean,
              value: false
            },
            /**
            * Whether dirty checking is enabled
            * @type {Boolean}
            * @default false
            */
            dirtyCheck: {
              type: Boolean,
              value: false
            }
          }
        }

        connectedCallback () {
          super.connectedCallback()
          if (this.dirtyCheck) {
            this._initialState = Object.assign({}, this.serializeForm())
          }
          this.addEventListener('keypress', this._submitOnEnter)
          this.addEventListener('sea-form-submit', this._submitOnSeaSubmit)
          this.addEventListener('iron-form-presubmit', this._submitted)
        }

        disconnectedCallback () {
          super.disconnectedCallback()
          this.removeEventListener('keypress', this._submitOnEnter)
          this.removeEventListener('sea-form-submit', this._submitOnSeaSubmit)
          this.removeEventListener('iron-form-presubmit', this._submitted)
        }

        /**
         * Listens for `keypress` events.
         *
         * Submits form when key is enter.
         *
         * @param {KeyboardEvent} event The `keypress` event
         */
        _submitOnEnter (event) {
          if (event.key !== 'Enter') return
          event.preventDefault()
          this.submit()
        }

        /**
        * Listens for `sea-form-submit` events.
        *
        * Submits form.
        *
        * @param {CustomEvent} event The `sea-form-submit` event
        * @return
        */
        _submitOnSeaSubmit (event) { this.submit() }

        /**
         * Listens for `iron-form-presubmit` events.
         *
         * Cancels default submission if needed and raises a `sea-form-submitted` event with serialized form as detail.
         *
         * @param {CustomEvent} event The `iron-form-presubmit` event
         * @return
         */
        _submitted (event) {
          if (this.nativeSubmissionEnabled !== true) event.preventDefault()

          if (this.dirtyCheck) {
            if (this._hasChanged()) {
              this.raise('sea-form-submitted', this._getChangedValues())
            }
          } else {
            this.raise('sea-form-submitted', this.serializeForm())
          }
        }

        _hasChanged () {
          const formData = this.serializeForm()
          return JSON.stringify(this._initialState) !== JSON.stringify(formData)
        }

        _getChangedValues () {
          const values = this.serializeForm()
          const newValues = {}
          Object.keys(this._initialState).forEach((key) => {
            if (this._initialState[key] !== values[key]) {
              newValues[key] = values[key]
            }
          })
          return newValues
        }

        /**
        * Raised when form is submitted.
        *
        * Contains serialized form in event details.
        *
        * @event sea-form-submitted
        */
      }

      customElements.define(Sea.Form.is, Sea.Form)
    })()
  </script>
</dom-module>
