<link rel="import"
      href="../iron-form/iron-form.html">
<link rel="import"
      href="../sea-element/sea-element-mixin.html">

<script>
  (() => {
    'use strict'
    const IronForm = customElements.get('iron-form')

    /**
    * # sea-form
    *
    * **A form decorator that can be submitted by pressing enter, or by a sea-form-submit event**
    *
    * Managed inputs must have:
    *   - A `name` attribute
    *   - A `value` attribute (and dispatch a bubbling & composed `value-changed` event)
    *   - A `validate` function
    *
    * Raises a `sea-form-submitted` event on submit, with the serialized form as detail.
    * If `dirtySubmitOnly` is enabled, only changed fields will be sent.
    *
    * @polymer
    * @customElement
    * @memberof Sea
    * @extends iron-form
    * @mixes Sea.ElementMixin
    * @demo demo/index.html
    */
    Sea.Form = class Form extends Sea.ElementMixin(IronForm) {
      static get properties () {
        return {
          /**
          * Whether only dirty values should be submitted
          * @type {Boolean}
          * @default false
          */
          dirtySubmitOnly: {
            type: Boolean,
            value: false
          },

          /**
          * Whether the form is dirty or not
          * @type {Boolean}
          * @default false
          */
          isDirty: {
            type: Boolean,
            notify: true,
            value: false
          },

          /**
          * The list of registered inputs
          * @type {Array}
          * @default []
          */
          _registeredInputs: {
            type: Array,
            value: []
          },

          /**
          * The values to compare dirtiness with
          * @type {Object}
          * @default {}
          */
          _initialValues: {
            type: Object,
            value: {}
          }
        }
      }

      connectedCallback () {
        super.connectedCallback()
        this.addEventListener('keypress', this._submitOnEnter)
        this.addEventListener('sea-form-submit', this._submitOnSeaSubmit)
        this.addEventListener('iron-form-presubmit', this._submitted)
        this._registerInputs()
      }

      disconnectedCallback () {
        super.disconnectedCallback()
        this.removeEventListener('keypress', this._submitOnEnter)
        this.removeEventListener('sea-form-submit', this._submitOnSeaSubmit)
        this.removeEventListener('iron-form-presubmit', this._submitted)
        this._registeredInputs.forEach(i => i.removeEventListener('value-changed', this._inputChanged))
      }

      /**
       * Sets current form values as initial values
       *
       * @return
       */
      setAsClean () {
        const _initialValues = this.__serializeInputs({ inputs: this._registeredInputs })
        this.setProperties({ isDirty: false, _initialValues })
      }

      /**
       * Serializes the form.
       *
       * If `dirtySubmitOnly` is enabled, only returns changed values
       *
       * @return {Object} The serialized values
       */
      serializeForm () {
        const currentValues = this.__serializeInputs({ inputs: this._registeredInputs })
        if (!this.dirtySubmitOnly) return currentValues
        return Object
          .entries(currentValues)
          .filter(entry => {
            const name = entry[0]
            const value = entry[1]
            return JSON.stringify(value) !== JSON.stringify(this._initialValues[name])
          })
          .reduce((dirtyValues, entry) => Object.assign(dirtyValues, { [entry[0]]: entry[1] }), {})
      }

      /**
       * Registers all manageable inputs in the form
       *
       * Manageable inputs must have:
       *   - A `name` attribute
       *   - A `value` attribute (and a dispatch a bubbling & composed `value-changed` event)
       *   - A `validate` function
       *
       * @return
       */
      _registerInputs () {
        const elements = this.querySelectorAll('[name][value]')
        const inputs = Array.from(elements).filter(e => e.validate)
        this.set('_registeredInputs', inputs)
        inputs.forEach(i => i.addEventListener('value-changed', (event) => this._inputChanged(event)))
        this.setAsClean()
      }

      /**
       * Listens for `keypress` events.
       *
       * Submits form when key is enter.
       *
       * @param {KeyboardEvent} event The `keypress` event
       */
      _submitOnEnter (event) {
        if (event.key !== 'Enter') return
        event.preventDefault()
        this.submit()
      }

      /**
      * Listens for `sea-form-submit` events.
      *
      * Submits form.
      *
      * @param {CustomEvent} event The `sea-form-submit` event
      * @return
      */
      _submitOnSeaSubmit (event) { this.submit() }

      /**
       * Listens for `iron-form-presubmit` events.
       *
       * Cancels default submission and raises a `sea-form-submitted` event with serialized form as detail.
       *
       * @param {CustomEvent} event The `iron-form-presubmit` event
       * @return
       */
      _submitted (event) {
        event.preventDefault()
        this.raise('sea-form-submitted', this.serializeForm())
      }

      /**
       * Listens for `value-changed` events.
       *
       * Updates the `isDirty` property.
       *
       * @param {CustomEvent} event The `value-changed` event
       * @return
       */
      _inputChanged (event) {
        const isDirty = this.__isFormDirty({ initialValues: this._initialValues, inputs: this._registeredInputs })
        this.set('isDirty', isDirty)
      }

      __isFormDirty ({ initialValues = {}, inputs = [] }) {
        const currentValues = this.__serializeInputs({ inputs })
        return JSON.stringify(initialValues) !== JSON.stringify(currentValues)
      }

      __serializeInputs ({ inputs = [] }) {
        return inputs
          .map(i => this.__serializeInput({ input: i }))
          .reduce((values, entry) => Object.assign(values, entry), {})
      }

      __serializeInput ({ input }) {
        let value = input.value
        if (input.type && input.type.toLowerCase() === 'number') {
          value = parseFloat(input.value)
        }

        return { [input.name]: value }
      }

      /**
      * Raised when form is submitted.
      *
      * Contains serialized form in event details.
      *
      * @event sea-form-submitted
      */
    }

    customElements.define('sea-form', Sea.Form)
  })()
</script>
