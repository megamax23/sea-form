<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>sea-form</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import"
        href="../sea-form.html">
  <link rel="import"
        href="../../paper-input/paper-input.html">
</head>

<body>

  <test-fixture id="default">
    <template>
      <sea-form>
        <form>
          <paper-input name="input1"
                       type="text"
                       value="someValue1"></paper-input>
          <paper-input name="input2"
                       type="number"
                       value="5"></paper-input>
        </form>
      </sea-form>
    </template>
  </test-fixture>

  <test-fixture id="dirty-submit-only">
    <template>
      <sea-form dirty-submit-only>
        <form>
          <paper-input name="input1"
                       type="text"
                       value="someValue1"></paper-input>
          <paper-input name="input2"
                       type="number"
                       value="5"></paper-input>
        </form>
      </sea-form>
    </template>
  </test-fixture>

  <script>
    describe('sea-form', () => {
      describe('a default form', () => {
        let component, submitMethod
        beforeEach(() => {
          component = fixture('default')
          submitMethod = sinon.stub(component, 'submit')
        })

        const pressKey = key => component.dispatchEvent(new KeyboardEvent('keypress', { key }))

        context('when Enter is pressed', () => {
          beforeEach(() => {
            pressKey('Enter')
          })

          it('is submitted', () => {
            expect(submitMethod).to.have.been.called()
          })
        })

        context('when any other key is pressed', () => {
          beforeEach(() => {
            pressKey('Space')
          })

          it('is never submitted', () => {
            expect(submitMethod).to.not.have.been.called()
          })
        })

        context('when form is submitted', () => {
          beforeEach(() => {
            submitMethod.restore()
          })

          it('raises a sea-form-submitted event with all values', (done) => {
            component.addEventListener('sea-form-submitted', (event) => {
              expect(event.detail).to.be.deep.equal({
                input1: 'someValue1',
                input2: 5
              })

              done()
            })

            flush(() => { component.submit() })
          })
        })

        describe('dirty-checking', () => {
          it('is initially not dirty', () => {
            expect(component.isDirty).to.be.false()
          })

          context('when changing an input\'s value', () => {
            let input, initialValue
            beforeEach((done) => {
              input = component.querySelector('paper-input')
              initialValue = input.value
              input.set('value', 'some changed value')
              flush(done)
            })

            it('becomes dirty', () => {
              expect(component.isDirty).to.be.true()
            })

            context('when changing it back', () => {
              beforeEach((done) => {
                input.set('value', initialValue)
                flush(done)
              })

              it('is not dirty anymore', () => {
                expect(component.isDirty).to.be.false()
              })
            })

            context('when setting as clean', () => {
              beforeEach(() => {
                component.setAsClean()
              })

              it('is not dirty anymore', () => {
                expect(component.isDirty).to.be.false()
              })
            })
          })
        })
      })

      describe('a dirty-submit-only form', () => {
        let component
        beforeEach(() => {
          component = fixture('dirty-submit-only')
        })

        context('when no value has changed', () => {
          context('when submitted', () => {
            it('raises a sea-form-submitted event with nothing', (done) => {
              component.addEventListener('sea-form-submitted', (event) => {
                expect(event.detail).to.be.deep.equal({})
                done()
              })

              flush(() => { component.submit() })
            })
          })
        })

        context('when a value has changed', () => {
          const editedFieldValue = 'some changed value'

          let input
          beforeEach((done) => {
            input = component.querySelector('[name=input1]')
            input.set('value', editedFieldValue)
            flush(done)
          })

          context('when submitted', () => {
            it('raises a sea-form-submitted event with only the changed value', (done) => {
              component.addEventListener('sea-form-submitted', (event) => {
                expect(event.detail).to.be.deep.equal({
                  [input.name]: editedFieldValue
                })

                done()
              })

              flush(() => { component.submit() })
            })
          })

          context('when setting as clean', () => {
            beforeEach(() => {
              component.setAsClean()
            })

            context('when submitted', () => {
              it('raises a sea-form-submitted event with nothing', (done) => {
                component.addEventListener('sea-form-submitted', (event) => {
                  expect(event.detail).to.be.deep.equal({})
                  done()
                })

                flush(() => { component.submit() })
              })
            })
          })
        })
      })
    })
  </script>

</body>

</html>
