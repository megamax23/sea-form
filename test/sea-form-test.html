<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>sea-form</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import"
        href="../sea-form.html">
</head>

<body>

  <test-fixture id="default">
    <template>
      <sea-form>
        <form>
          <input name="input1"
                 type="text"
                 value="someValue1">
          <input name="input2"
                 type="text"
                 value="someValue2">
        </form>
      </sea-form>
    </template>
  </test-fixture>

  <test-fixture id="dirty-check">
    <template>
      <sea-form dirty-check>
        <form>
          <input name="input1"
                 type="text"
                 value="someValue1">
        </form>
      </sea-form>
    </template>
  </test-fixture>

  <test-fixture id="with-number-input">
    <template>
      <sea-form>
        <form>
          <input type="number"
                 name="numberInput"
                 value="10">
        </form>
      </sea-form>
    </template>
  </test-fixture>

  <script>
    describe('sea-form', () => {
      let component
      beforeEach(() => { component = fixture('default') })

      context('when pressing a key', () => {
        const pressKey = (key) => { component.dispatchEvent(new KeyboardEvent('keypress', { key })) }

        let submitMethod
        beforeEach(() => { submitMethod = sinon.stub(component, 'submit') })

        afterEach(() => { submitMethod.reset() })

        context('when key is Enter', () => {
          it('submits the form', (done) => {
            component.addEventListener('keypress', () => {
              expect(submitMethod).to.have.been.called()
              done()
            })

            pressKey('Enter')
          })
        })

        context('when the key is not Enter', () => {
          it('does not submit the form', (done) => {
            component.addEventListener('keypress', () => {
              expect(submitMethod).to.not.have.been.called()
              done()
            })

            pressKey('Space')
          })
        })
      })

      context('when an iron-form-presubmit event is raised', () => {
        const ironFormPresubmit = () => {
          component.dispatchEvent(new CustomEvent('iron-form-presubmit', {
            composed: true,
            bubbles: true,
            cancelable: true
          }))
        }

        it('raises a sea-form-submitted event', (done) => {
          component.addEventListener('sea-form-submitted', (event) => done())

          ironFormPresubmit()
        })

        context('when native form submission is disabled', () => {
          it('prevents the event\'s default', (done) => {
            component.addEventListener('iron-form-presubmit', (event) => {
              expect(event.defaultPrevented).to.be.true()
              done()
            })

            ironFormPresubmit()
          })
        })

        context('when native form submission is enabled', () => {
          beforeEach(() => { component.set('nativeSubmissionEnabled', true) })

          it('does no prevent the event\'s default', (done) => {
            component.addEventListener('iron-form-presubmit', (event) => {
              expect(event.defaultPrevented).to.be.false()
              done()
            })

            ironFormPresubmit()
          })
        })
      })

      context('when dirty checking is enabled', () => {
        let input, initialValue

        beforeEach(() => {
          component = fixture('dirty-check')

          input = component.querySelector('input[name="input1"]')
          initialValue = input.value

          _enterValue(input, initialValue)
        })

        context('when an input change', () => {
          context('with a different value', () => {
            beforeEach(() => {
              _enterValue(input, 'newValue')
            })

            it('becomes dirty', () => {
              expect(component.isDirty).to.be.true()
            })
          })

          context('with its initial value', () => {
            beforeEach(() => {
              _enterValue(input, initialValue)
            })

            it('becomes not dirty', () => {
              expect(component.isDirty).to.be.false()
            })
          })
        })

        context('when a form is dirty', () => {
          beforeEach(() => {
            component.set('isDirty', true)
          })

          context('when setAsClean', () => {
            beforeEach(() => {
              component.setAsClean()
            })

            it('becomes not dirty', () => {
              expect(component.isDirty).to.be.false()
            })
          })
        })

        context('when submitting the form', () => {
          context('and no inputs have changed', () => {
            it('does not raise a sea-form-submitted event', () => {
              const spy = sinon.spy()
              component.addEventListener('sea-form-submitted', spy)

              component.submit()

              expect(spy).to.not.have.been.called()
            })
          })

          context('and inputs have changed', () => {
            let eventDetailWithNewValue
            let newValue = 'newValue'

            beforeEach(() => {
              eventDetailWithNewValue = { input1: newValue }

              _enterValue(input, newValue)
            })

            it('sends the changed values', () => {
              component.addEventListener('sea-form-submitted', (event) => {
                expect(event.detail).to.deep.equal(eventDetailWithNewValue)
              })

              component.submit()
            })
          })
        })
      })

      context('when containing a number input', () => {
        context('when serializeForm', () => {
          let serializedInputs
          beforeEach((done) => {
            component = fixture('with-number-input')

            flush(() => {
              serializedInputs = component.serializeForm()

              done()
            })
          })

          it('serializes the number input value is a number', () => {
            expect(serializedInputs.numberInput).to.be.deep.equal(10)
          })
        })
      })
    })

    function _enterValue (input, value) {
      input.setAttribute('value', value)
      input.dispatchEvent(new Event('input', { composed: true, bubbles: true }))
    }
  </script>

</body>

</html>
